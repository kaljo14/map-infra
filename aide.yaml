apiVersion: v1
data:
  envoy.yaml: "apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: scraper-envoy-config\n
    \ namespace: default\ndata:\n  envoy.yaml: |\n    admin:\n      address:\n        socket_address:\n
    \         address: 127.0.0.1\n          port_value: 9901\n    \n    static_resources:\n
    \     listeners:\n      - name: listener_0\n        address:\n          socket_address:\n
    \           address: 0.0.0.0\n            port_value: 8000\n        filter_chains:\n
    \       - filters:\n          - name: envoy.filters.network.http_connection_manager\n
    \           typed_config:\n              \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\n
    \             stat_prefix: ingress_http\n              codec_type: AUTO\n              \n
    \             access_log:\n              - name: envoy.access_loggers.stdout\n
    \               typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog\n
    \                 log_format:\n                    json_format:\n                      start_time:
    \"%START_TIME%\"\n                      method: \"%REQ(:METHOD)%\"\n                      path:
    \"%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%\"\n                      response_code: \"%RESPONSE_CODE%\"\n
    \                     user: \"%DYNAMIC_METADATA(envoy.filters.http.jwt_authn:jwt_payload:sub)%\"\n\n
    \             route_config:\n                name: local_route\n                virtual_hosts:\n
    \               - name: backend\n                  domains: [\"*\"]\n                  routes:\n
    \                 - match:\n                      prefix: \"/\"\n                    route:\n
    \                     cluster: local_service\n              \n              http_filters:\n
    \             # JWT Authentication\n              - name: envoy.filters.http.jwt_authn\n
    \               typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication\n
    \                 providers:\n                    keycloak:\n                      issuer:
    \"https://keycloack.mustaci.com/realms/barbershop-realm\"\n                      audiences:\n
    \                     - \"barbershop-app\"\n                      remote_jwks:\n
    \                       http_uri:\n                          uri: \"http://keycloak.default.svc.cluster.local/realms/barbershop-realm/protocol/openid-connect/certs\"\n
    \                         cluster: keycloak_cluster\n                          timeout:
    5s\n                        cache_duration:\n                          seconds:
    300\n                      forward: true\n                      payload_in_metadata:
    jwt_payload\n                      from_headers:\n                      - name:
    Authorization\n                        value_prefix: \"Bearer \"\n                  rules:\n
    \                 - match:\n                      prefix: \"/\"\n                    requires:\n
    \                     provider_name: \"keycloak\"\n\n              # RBAC\n              -
    name: envoy.filters.http.rbac\n                typed_config:\n                  \"@type\":
    type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBAC\n                  rules:\n
    \                   action: ALLOW\n                    policies:\n                      \"read-access\":\n
    \                       permissions:\n                          - header:\n                              name:
    \":method\"\n                              string_match:\n                                exact:
    \"GET\"\n                        principals:\n                          - metadata:\n
    \                             filter: envoy.filters.http.jwt_authn\n                              path:\n
    \                               - key: jwt_payload\n                                -
    key: realm_access\n                                - key: roles\n                              value:\n
    \                               list_match:\n                                  one_of:\n
    \                                   string_match:\n                                      exact:
    \"data-viewer\"\n                          - metadata:\n                              filter:
    envoy.filters.http.jwt_authn\n                              path:\n                                -
    key: jwt_payload\n                                - key: realm_access\n                                -
    key: roles\n                              value:\n                                list_match:\n
    \                                 one_of:\n                                    string_match:\n
    \                                     exact: \"admin\"\n                      \n
    \                     \"write-access\":\n                        permissions:\n
    \                         - header:\n                              name: \":method\"\n
    \                             string_match:\n                                exact:
    \"POST\"\n                          - header:\n                              name:
    \":method\"\n                              string_match:\n                                exact:
    \"PUT\"\n                          - header:\n                              name:
    \":method\"\n                              string_match:\n                                exact:
    \"DELETE\"\n                        principals:\n                          - metadata:\n
    \                             filter: envoy.filters.http.jwt_authn\n                              path:\n
    \                               - key: jwt_payload\n                                -
    key: realm_access\n                                - key: roles\n                              value:\n
    \                               list_match:\n                                  one_of:\n
    \                                   string_match:\n                                      exact:
    \"data-editor\"\n                          - metadata:\n                              filter:
    envoy.filters.http.jwt_authn\n                              path:\n                                -
    key: jwt_payload\n                                - key: realm_access\n                                -
    key: roles\n                              value:\n                                list_match:\n
    \                                 one_of:\n                                    string_match:\n
    \                                     exact: \"admin\"\n\n              - name:
    envoy.filters.http.router\n                typed_config:\n                  \"@type\":
    type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n      \n      clusters:\n
    \     - name: local_service\n        connect_timeout: 0.25s\n        type: STATIC\n
    \       lb_policy: ROUND_ROBIN\n        load_assignment:\n          cluster_name:
    local_service\n          endpoints:\n          - lb_endpoints:\n            -
    endpoint:\n                address:\n                  socket_address:\n                    address:
    127.0.0.1\n                    port_value: 3000\n      \n      - name: keycloak_cluster\n
    \       connect_timeout: 5s\n        type: STRICT_DNS\n        lb_policy: ROUND_ROBIN\n
    \       load_assignment:\n          cluster_name: keycloak_cluster\n          endpoints:\n
    \         - lb_endpoints:\n            - endpoint:\n                address:\n
    \                 socket_address:\n                    address: keycloak.default.svc.cluster.local\n
    \                   port_value: 80\n"
kind: ConfigMap
metadata:
  labels:
    env: production
    managed-by: kustomize
  name: scraper-envoy-config-tbkth86d29
  namespace: map
---
apiVersion: v1
data:
  envoy.yaml: "apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: tileserver-envoy-config\n
    \ namespace: default\ndata:\n  envoy.yaml: |\n    admin:\n      address:\n        socket_address:\n
    \         address: 127.0.0.1\n          port_value: 9901\n    \n    static_resources:\n
    \     listeners:\n      - name: listener_0\n        address:\n          socket_address:\n
    \           address: 0.0.0.0\n            port_value: 8000\n        filter_chains:\n
    \       - filters:\n          - name: envoy.filters.network.http_connection_manager\n
    \           typed_config:\n              \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\n
    \             stat_prefix: ingress_http\n              codec_type: AUTO\n              \n
    \             access_log:\n              - name: envoy.access_loggers.stdout\n
    \               typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog\n
    \                 log_format:\n                    json_format:\n                      start_time:
    \"%START_TIME%\"\n                      method: \"%REQ(:METHOD)%\"\n                      path:
    \"%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%\"\n                      response_code: \"%RESPONSE_CODE%\"\n
    \                     user: \"%DYNAMIC_METADATA(envoy.filters.http.jwt_authn:jwt_payload:sub)%\"\n\n
    \             route_config:\n                name: local_route\n                virtual_hosts:\n
    \               - name: backend\n                  domains: [\"*\"]\n                  routes:\n
    \                 - match:\n                      prefix: \"/\"\n                    route:\n
    \                     cluster: local_service\n              \n              http_filters:\n
    \             # JWT Authentication\n              - name: envoy.filters.http.jwt_authn\n
    \               typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication\n
    \                 providers:\n                    keycloak:\n                      #
    Issuer must match the token exactly (usually external URL)\n                      issuer:
    \"https://keycloack.mustaci.com/realms/barbershop-realm\"\n                      audiences:\n
    \                     - \"barbershop-app\"\n                      remote_jwks:\n
    \                       http_uri:\n                          # Internal URL to
    fetch keys (faster, stays in cluster)\n                          uri: \"http://keycloak.default.svc.cluster.local/realms/barbershop-realm/protocol/openid-connect/certs\"\n
    \                         cluster: keycloak_cluster\n                          timeout:
    5s\n                        cache_duration:\n                          seconds:
    300\n                      forward: true\n                      payload_in_metadata:
    jwt_payload\n                      from_headers:\n                      - name:
    Authorization\n                        value_prefix: \"Bearer \"\n                  rules:\n
    \                 - match:\n                      prefix: \"/\"\n                    requires:\n
    \                     provider_name: \"keycloak\"\n\n              # RBAC\n              -
    name: envoy.filters.http.rbac\n                typed_config:\n                  \"@type\":
    type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBAC\n                  rules:\n
    \                   action: ALLOW\n                    policies:\n                      \"map-access\":\n
    \                       permissions:\n                          - any: true\n
    \                       principals:\n                          - metadata:\n                              filter:
    envoy.filters.http.jwt_authn\n                              path:\n                                -
    key: jwt_payload\n                                - key: realm_access\n                                -
    key: roles\n                              value:\n                                list_match:\n
    \                                 one_of:\n                                    string_match:\n
    \                                     exact: \"map-viewer\"\n                          -
    metadata:\n                              filter: envoy.filters.http.jwt_authn\n
    \                             path:\n                                - key: jwt_payload\n
    \                               - key: realm_access\n                                -
    key: roles\n                              value:\n                                list_match:\n
    \                                 one_of:\n                                    string_match:\n
    \                                     exact: \"admin\"\n\n              - name:
    envoy.filters.http.router\n                typed_config:\n                  \"@type\":
    type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n      \n      clusters:\n
    \     - name: local_service\n        connect_timeout: 0.25s\n        type: STATIC\n
    \       lb_policy: ROUND_ROBIN\n        load_assignment:\n          cluster_name:
    local_service\n          endpoints:\n          - lb_endpoints:\n            -
    endpoint:\n                address:\n                  socket_address:\n                    address:
    127.0.0.1\n                    port_value: 8080\n      \n      - name: keycloak_cluster\n
    \       connect_timeout: 5s\n        type: STRICT_DNS\n        lb_policy: ROUND_ROBIN\n
    \       load_assignment:\n          cluster_name: keycloak_cluster\n          endpoints:\n
    \         - lb_endpoints:\n            - endpoint:\n                address:\n
    \                 socket_address:\n                    address: keycloak.default.svc.cluster.local\n
    \                   port_value: 80\n"
kind: ConfigMap
metadata:
  labels:
    env: production
    managed-by: kustomize
  name: tileserver-envoy-config-btktm68g96
  namespace: map
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: frontend
    env: production
    managed-by: kustomize
  name: frontend
  namespace: map
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: frontend
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: places-scraper
    env: production
    managed-by: kustomize
  name: places-scraper
  namespace: map
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8000
  selector:
    app: places-scraper
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: tileserver
    env: production
    managed-by: kustomize
  name: tileserver
  namespace: map
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8000
  selector:
    app: tileserver
  type: ClusterIP
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    env: production
    managed-by: kustomize
  name: tiles-pvc
  namespace: map
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 2Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: frontend
    env: production
    managed-by: kustomize
  name: frontend
  namespace: map
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - image: kaljo14/my-map:latest
        name: frontend
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: places-scraper
    env: production
    managed-by: kustomize
  name: places-scraper
  namespace: map
spec:
  replicas: 1
  selector:
    matchLabels:
      app: places-scraper
  template:
    metadata:
      labels:
        app: places-scraper
    spec:
      containers:
      - image: envoyproxy/envoy:v1.29-latest
        name: envoy
        ports:
        - containerPort: 8000
          name: http
          protocol: TCP
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 50m
            memory: 64Mi
        volumeMounts:
        - mountPath: /etc/envoy
          name: envoy-config
          readOnly: true
      - env:
        - name: PORT
          value: "3000"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              key: POSTGRES_USER
              name: places-scraper-secret
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              key: POSTGRES_PASSWORD
              name: places-scraper-secret
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              key: POSTGRES_DB
              name: places-scraper-secret
        - name: POSTGRES_CONN_STRING
          valueFrom:
            secretKeyRef:
              key: POSTGRES_CONN_STRING
              name: places-scraper-secret
        image: your-scraper-image:latest
        name: places-scraper
        ports:
        - containerPort: 3000
          name: app-port
          protocol: TCP
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 256Mi
      volumes:
      - configMap:
          items:
          - key: envoy.yaml
            path: envoy.yaml
          name: scraper-envoy-config-tbkth86d29
        name: envoy-config
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: tileserver
    env: production
    managed-by: kustomize
  name: tileserver
  namespace: map
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tileserver
  template:
    metadata:
      labels:
        app: tileserver
    spec:
      containers:
      - image: envoyproxy/envoy:v1.29-latest
        name: envoy
        ports:
        - containerPort: 8000
          name: http
          protocol: TCP
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 50m
            memory: 64Mi
        volumeMounts:
        - mountPath: /etc/envoy
          name: envoy-config
          readOnly: true
      - args:
        - -p
        - "8080"
        image: maptiler/tileserver-gl:latest
        name: tileserver
        ports:
        - containerPort: 8080
          name: app-port
          protocol: TCP
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
        - mountPath: /data
          name: tiles
      volumes:
      - configMap:
          items:
          - key: envoy.yaml
            path: envoy.yaml
          name: tileserver-envoy-config-btktm68g96
        name: envoy-config
      - name: tiles
        persistentVolumeClaim:
          claimName: tiles-pvc
---
apiVersion: batch/v1
kind: Job
metadata:
  labels:
    env: production
    managed-by: kustomize
  name: grid-tile-generator
  namespace: map
spec:
  backoffLimit: 2
  template:
    spec:
      containers:
      - image: kaljo14/grid-tile-generator:latest
        name: generator
        volumeMounts:
        - mountPath: /data
          name: tiles
      restartPolicy: Never
      volumes:
      - name: tiles
        persistentVolumeClaim:
          claimName: tiles-pvc
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.middlewares: default-redirect-https@kubernetescrd
  labels:
    env: production
    managed-by: kustomize
  name: frontend-ingress
  namespace: map
spec:
  ingressClassName: traefik
  rules:
  - host: mustaci.com
    http:
      paths:
      - backend:
          service:
            name: frontend
            port:
              number: 80
        path: /
        pathType: Prefix
  - host: www.mustaci.com
    http:
      paths:
      - backend:
          service:
            name: frontend
            port:
              number: 80
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - mustaci.com
    - www.mustaci.com
    secretName: frontend-tls
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.middlewares: default-redirect-https@kubernetescrd
  labels:
    env: production
    managed-by: kustomize
  name: scraper-ingress
  namespace: map
spec:
  ingressClassName: traefik
  rules:
  - host: places-scraper.mustaci.com
    http:
      paths:
      - backend:
          service:
            name: places-scraper
            port:
              number: 80
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - places-scraper.mustaci.com
    secretName: api-tls
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.middlewares: default-redirect-https@kubernetescrd
  labels:
    env: production
    managed-by: kustomize
  name: tileserver-ingress
  namespace: map
spec:
  ingressClassName: traefik
  rules:
  - host: tiles.mustaci.com
    http:
      paths:
      - backend:
          service:
            name: tileserver
            port:
              number: 80
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - tiles.mustaci.com
    secretName: tiles-tls
